# Progress MOVEit Transfer check for CVE-2024-5806
## Written by Michael Weimer
# Checks for vulnerable versions of Progress MoveIT Transfer, which are the following: 
# MOVEit Transfer: 
## MOVEit Transfer 2023.0.x (fixed in MOVEit Transfer 2023.0.11)
## MOVEit Transfer 2023.1.x (fixed in MOVEit Transfer 2023.1.6)
## MOVEit Transfer 2024.0.x (fixed in MOVEit Transfer 2024.0.2)
# MOVEit Gateway: 
## MOVEit Gateway 2024.0.0 (fixed in MOVEit Gateway 2024.0.1)

import argparse
import requests
import urllib3
from paramiko import Transport

# Suppress warnings about insecure connections
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

# Vulnerable versions
vulnerable_versions = {
    "MOVEit Transfer": [
        "2023.0.", "2023.1.", "2024.0."
    ],
    "MOVEit Gateway": [
        "2024.0.0"
    ]
}

def check_http_version(target_ip, target_web_port):
    try:
        url = f"https://{target_ip}:{target_web_port}"
        response = requests.get(url, verify=False)
        headers = response.headers

        # Check for version information in headers
        server_header = headers.get("Server", "")
        print(f"Server Header: {server_header}")
        
        for product, versions in vulnerable_versions.items():
            for version in versions:
                if version in server_header:
                    print(f"Vulnerable {product} version detected: {server_header}")
                    return True

        print("No vulnerable version detected in HTTP headers.")
        return False
    except Exception as e:
        print(f"Error connecting to {url}: {e}")
        return False

def check_ssh_version(target_ip, target_sftp_port):
    try:
        transport = Transport((target_ip, target_sftp_port))
        transport.start_client()
        banner = transport.remote_version
        print(f"SSH Banner: {banner}")
        transport.close()

        for product, versions in vulnerable_versions.items():
            for version in versions:
                if version in banner:
                    print(f"Vulnerable {product} version detected: {banner}")
                    return True

        print("No vulnerable version detected in SSH banner.")
        return False
    except Exception as e:
        print(f"Error connecting to {target_ip}:{target_sftp_port} - {e}")
        return False

def main(args):
    http_vulnerable = check_http_version(args.target_ip, args.target_web_port)
    ssh_vulnerable = check_ssh_version(args.target_ip, args.target_sftp_port)

    if http_vulnerable or ssh_vulnerable:
        print("The target server is potentially vulnerable to CVE-2024-5806.")
    else:
        print("The target server does not appear to be vulnerable to CVE-2024-5806.")

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Check for vulnerable versions of Progress MOVEit Transfer (CVE-2024-5806).")
    parser.add_argument('--target-ip', '-t', dest='target_ip', help='Target IP', required=True)
    parser.add_argument('--target-web-port', dest='target_web_port', help='Target Web Port', type=int, default=443, required=False)
    parser.add_argument('--target-sftp-port', dest='target_sftp_port', help='Target SFTP Port', type=int, default=22, required=False)

    args = parser.parse_args()
    main(args)
